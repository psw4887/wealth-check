<!DOCTYPE html>

<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ìì‚° ê´€ë¦¬</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
:root{--bg:#0f172a;--card:#1e293b;--text:#f1f5f9;--muted:#94a3b8;--pri:#60a5fa;--suc:#4ade80;--warn:#fbbf24;--dan:#f87171;--brd:#334155}
.light{--bg:#fff5f8;--card:#fff;--text:#4a2040;--muted:#a07090;--pri:#f48fb1;--suc:#81c784;--warn:#ffb74d;--dan:#e57373;--brd:#f8d7e8}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text)}
.app{display:flex;flex-direction:column;height:100%;padding-top:env(safe-area-inset-top)}
.hdr{padding:10px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--brd);background:var(--card)}
.hdr h1{font-size:1rem}
.hdr-user{display:flex;align-items:center;gap:8px}
.hdr-user img{width:28px;height:28px;border-radius:50%}
.hdr-user span{font-size:11px;color:var(--muted);max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cnt{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:10px}
.bnav{display:flex;background:var(--card);border-top:1px solid var(--brd);padding-bottom:env(safe-area-inset-bottom)}
.nav-i{flex:1;padding:8px 4px;text-align:center;color:var(--muted);border:none;background:none;font-size:9px}
.nav-i.act{color:var(--pri);font-weight:600}
.nav-i .ico{font-size:18px;display:block}
.btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-size:12px;font-weight:600}
.btn:active{transform:scale(.96)}
.btn-p{background:var(--pri);color:#fff}
.btn-o{background:transparent;border:1px solid var(--brd);color:var(--text)}
.btn-d{background:var(--dan);color:#fff}
.btn-g{background:none;border:none;color:var(--muted);padding:6px}
.btn-w{background:var(--warn);color:#000}
.btn-sm{padding:6px 10px;font-size:11px}
.btn-xs{padding:4px 8px;font-size:10px}
.btn-ic{padding:6px;min-width:36px;min-height:36px;border-radius:8px}
.card{background:var(--card);border-radius:12px;padding:12px;border:1px solid var(--brd);margin-bottom:10px}
.card-t{font-size:13px;font-weight:600;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.g4{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-bottom:10px}
.stat{background:var(--card);border-radius:10px;padding:10px 8px;border:1px solid var(--brd);text-align:center}
.stat-l{font-size:9px;color:var(--muted);margin-bottom:2px}
.stat-v{font-size:.95rem;font-weight:700}
.stat-s{font-size:8px;color:var(--muted);margin-top:1px}
.stat.done{border-color:var(--suc)}.stat.done .stat-v{color:var(--suc)}
.stat.pending .stat-v{color:var(--warn)}
.li{display:flex;align-items:center;padding:10px 4px;border-bottom:1px solid var(--brd);gap:8px;flex-wrap:wrap}
.li:last-child{border-bottom:none}
.li-i{flex:1;min-width:0}
.li-n{font-size:13px;font-weight:500}
.li-sub{font-size:10px;color:var(--muted)}
.li-v{font-size:13px;font-weight:600}
.li-acts{display:flex;gap:4px;width:100%}
.prog{height:6px;background:var(--brd);border-radius:3px;overflow:hidden}
.prog-f{height:100%;border-radius:3px;transition:width .5s}
.gc{background:var(--bg);border-radius:10px;padding:10px;border:1px solid var(--brd);margin-bottom:8px}
.gc.done{border-color:var(--suc)}
.gc-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.gc-n{font-weight:600;font-size:12px}
.gc-i{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-top:6px}
.tabs{display:flex;gap:4px;margin-bottom:10px;overflow-x:auto}
.tab{padding:7px 12px;font-size:11px;border-radius:6px;background:var(--bg);color:var(--muted);border:1px solid var(--brd);white-space:nowrap}
.tab.act{background:var(--pri);color:#fff;border-color:var(--pri)}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:flex;align-items:flex-end;opacity:0;visibility:hidden;transition:all .25s}
.mo.act{opacity:1;visibility:visible}
.md{background:var(--card);border-radius:16px 16px 0 0;padding:16px;padding-bottom:calc(16px + env(safe-area-inset-bottom));width:100%;max-height:85vh;overflow-y:auto;transform:translateY(100%);transition:transform .3s}
.mo.act .md{transform:translateY(0)}
.md h3{text-align:center;margin-bottom:14px;font-size:15px}
.md-h{width:36px;height:4px;background:var(--brd);border-radius:2px;margin:0 auto 12px}
.fg{margin-bottom:10px}
.fg label{display:block;font-size:11px;color:var(--muted);margin-bottom:4px}
.fr{display:flex;gap:8px}
.fr>*{flex:1}
input,select{background:var(--bg);border:1px solid var(--brd);color:var(--text);padding:10px;border-radius:8px;font-size:14px;width:100%}
input:focus,select:focus{border-color:var(--pri);outline:none}
.amt-i{display:flex;align-items:center;gap:6px}
.amt-i input{width:70px;text-align:center}
.amt-i span{color:var(--muted);font-size:12px}
.md-btns{display:flex;gap:8px;margin-top:14px}
.md-btns .btn{flex:1;padding:12px}
.toast{position:fixed;top:calc(12px + env(safe-area-inset-top));left:50%;transform:translateX(-50%) translateY(-100px);background:var(--card);border:1px solid var(--brd);padding:10px 14px;border-radius:10px;font-size:12px;z-index:200;transition:transform .4s}
.toast.show{transform:translateX(-50%) translateY(0)}
.badge{display:inline-block;padding:1px 5px;border-radius:3px;font-size:9px;margin-left:4px}
.badge-warn{background:var(--warn);color:#000}
.badge-pri{background:var(--pri);color:#fff}
.badge-suc{background:var(--suc);color:#000}
.badge-fixed{background:var(--muted);color:#fff}
.no-item{text-align:center;padding:14px;color:var(--muted);font-size:11px}
.dep-d{font-size:10px;color:var(--suc)}
.hist-b{font-size:9px;color:var(--muted);text-decoration:underline;cursor:pointer;margin-left:6px}
.chart-box{height:160px;margin-bottom:10px}
.trend{height:120px;margin-top:8px}
.month-sel{display:flex;align-items:center;gap:6px;margin-bottom:10px}
.month-sel input{padding:4px 8px;font-size:11px;width:auto;min-width:110px}
.filter-row{display:flex;gap:4px;margin-bottom:8px}
.filter-row select{padding:4px 6px;font-size:9px;border-radius:4px;flex:1;max-width:90px}
.link-info{font-size:10px;color:var(--pri);background:var(--bg);padding:6px;border-radius:5px;margin-top:6px}
.loan-info{font-size:10px;color:var(--muted);margin-top:6px;padding:6px;background:var(--card);border-radius:6px}
.loan-info div{margin-bottom:3px}
.calc-box{background:var(--bg);border-radius:6px;padding:10px;margin-top:10px;font-size:11px}
.calc-box .row{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--brd)}
.calc-box .row:last-child{border-bottom:none;font-weight:600;color:var(--pri)}
.todo-input{display:flex;gap:6px;margin-bottom:12px}
.todo-input input{flex:1}
.todo-item{display:flex;align-items:center;gap:8px;padding:10px;background:var(--bg);border-radius:8px;margin-bottom:6px;border:1px solid var(--brd)}
.todo-item.done{opacity:.6}
.todo-item.done .todo-text{text-decoration:line-through}
.todo-check{width:20px;height:20px;border-radius:50%;border:2px solid var(--brd);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.todo-check.checked{background:var(--suc);border-color:var(--suc);color:#fff}
.todo-text{flex:1;font-size:13px}
.todo-del{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px}
.set-card{background:var(--card);border-radius:12px;padding:12px;border:1px solid var(--brd);margin-bottom:10px}
.set-card h4{font-size:13px;font-weight:600;margin-bottom:8px}
.set-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--brd)}
.set-row:last-child{border-bottom:none}
.set-desc{font-size:10px;color:var(--muted);margin-top:6px;line-height:1.5}
.expand-btn{background:none;border:none;color:var(--muted);font-size:10px;cursor:pointer;padding:4px 8px}
.gc-detail{overflow:hidden;max-height:0;transition:max-height .3s}
.gc-detail.open{max-height:200px}
.guide{background:linear-gradient(135deg,var(--pri),#8b5cf6);border-radius:12px;padding:14px;margin-bottom:10px;color:#fff}
.guide-t{font-size:13px;font-weight:700;margin-bottom:6px}
.guide-d{font-size:11px;opacity:.9;margin-bottom:10px;line-height:1.5}
.conf{position:fixed;inset:0;pointer-events:none;z-index:300}
.login-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:20px;text-align:center}
.login-wrap h2{font-size:24px;margin-bottom:8px}
.login-wrap p{color:var(--muted);font-size:13px;margin-bottom:24px}
.login-wrap .btn{padding:14px 32px;font-size:14px;display:flex;align-items:center;gap:10px}
.login-wrap .btn img{width:20px;height:20px}
.sync-status{font-size:9px;padding:2px 6px;border-radius:4px;margin-left:6px}
.sync-ok{background:var(--suc);color:#000}
.sync-ing{background:var(--warn);color:#000}
.sync-err{background:var(--dan);color:#fff}
.loading{display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:12px}
.spinner{width:32px;height:32px;border:3px solid var(--brd);border-top-color:var(--pri);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(min-width:480px){.g4{grid-template-columns:repeat(4,1fr)}}
  </style>
</head>
<body>
<div class="app">
  <header class="hdr">
    <h1>ğŸ’° ìì‚° ê´€ë¦¬</h1>
    <div id="hdrRight"></div>
  </header>
  <main class="cnt" id="cnt"></main>
  <nav class="bnav" id="bnav" style="display:none"></nav>
</div>
<div class="mo" id="mo"><div class="md" id="md"></div></div>
<div class="toast" id="toast"></div>
<canvas class="conf" id="conf"></canvas>

<script>
// ==================== Firebase ì„¤ì • ====================
const firebaseConfig = {
  apiKey: "AIzaSyBx5XJtU0fq_JC4A327tQoNgqgbswx08-w",
  authDomain: "wealth-check-ca82e.firebaseapp.com",
  projectId: "wealth-check-ca82e",
  storageBucket: "wealth-check-ca82e.firebasestorage.app",
  messagingSenderId: "628718286696",
  appId: "1:628718286696:web:f02ccd987f20daf87888dd"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ==================== ìƒìˆ˜ & ìƒíƒœ ====================
const $=id=>document.getElementById(id),
$$=s=>[...document.querySelectorAll(s)],
LS_KEY='WealthData',
DEF={assets:[],income:[],expense:[],fixedIncome:[],fixedExpense:[],goals:[],loans:[],todos:[],monthlyRecords:{},history:[]};

let D={...DEF},currentUser=null,syncStatus='ok',chart=null,trend=null,undoData=null,expandedLoans=new Set(),
state={tab:'dash',aTab:'list',gTab:'goals',tTab:'all',trendView:'month',flowMonth:gTM(),assetSort:'order',assetFilter:'all',goalSort:'order',loanSort:'order'};

// ==================== ìœ í‹¸ë¦¬í‹° ====================
function gTM(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}
function gML(){return new Date().getMonth()+1+'ì›”';}
function fmt(n){return new Intl.NumberFormat('ko-KR').format(n);}
function fmtS(n){const abs=Math.abs(n),s=n<0?'-':'';if(abs>=1e8){const u=Math.floor(abs/1e8),m=Math.floor((abs%1e8)/1e4);return m>0?s+u+'ì–µ '+m+'ë§Œ':s+u+'ì–µ';}return abs>=1e4?s+Math.floor(abs/1e4)+'ë§Œ':fmt(n);}
function fmtDate(d){if(!d)return'-';const[y,m]=d.split('-');return y.slice(2)+'.'+m;}
function localDate(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function genId(){return Date.now()+Math.floor(Math.random()*1e4);}
function isL(){return document.body.classList.contains('light');}
function gpc(t){const c=isL()?{pri:'#f48fb1',suc:'#81c784',warn:'#ffb74d',dan:'#e57373'}:{pri:'#60a5fa',suc:'#4ade80',warn:'#fbbf24',dan:'#f87171'};return c[t]||c.pri;}
function gc(){return isL()?['#f48fb1','#81c784','#ffb74d','#ce93d8','#90caf9']:['#60a5fa','#4ade80','#fbbf24','#f87171','#a78bfa'];}
function diffMonth(s,e){if(!s||!e)return 0;const sd=new Date(s+'-01'),ed=new Date(e+'-01');return Math.max(1,(ed.getFullYear()-sd.getFullYear())*12+ed.getMonth()-sd.getMonth()+1);}
function remainMonth(e){if(!e)return 0;const n=new Date(),ed=new Date(e+'-01');return Math.max(1,(ed.getFullYear()-n.getFullYear())*12+ed.getMonth()-n.getMonth()+1);}
function isMatured(e){return e&&new Date()>=new Date(e+'-01');}
function adjMonth(m,delta){const[y,mo]=m.split('-').map(Number),d=new Date(y,mo-1+delta);return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}

// ==================== ì €ì¥/ë¡œë“œ (Firebase + localStorage) ====================
let saveTimeout=null;

async function saveToFirestore(){
  if(!currentUser)return;
  syncStatus='ing';updateSyncUI();
  try{
    await db.collection('users').doc(currentUser.uid).set({data:D,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
    syncStatus='ok';
  }catch(e){
    console.error('Firestore save error:',e);
    syncStatus='err';
  }
  updateSyncUI();
}

async function loadFromFirestore(){
  if(!currentUser)return false;
  try{
    const doc=await db.collection('users').doc(currentUser.uid).get();
    if(doc.exists&&doc.data().data){
      const p=doc.data().data;
      D=JSON.parse(JSON.stringify(DEF));
      ['assets','income','expense','fixedIncome','fixedExpense','goals','loans','todos','history'].forEach(k=>{
        if(Array.isArray(p[k]))D[k]=p[k];
      });
      if(p.monthlyRecords)D.monthlyRecords=p.monthlyRecords;
      return true;
    }
  }catch(e){console.error('Firestore load error:',e);}
  return false;
}

function saveToLS(){try{localStorage.setItem(LS_KEY,JSON.stringify(D));}catch(e){}}
function loadFromLS(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(!raw)return false;
    const p=JSON.parse(raw);
    D=JSON.parse(JSON.stringify(DEF));
    ['assets','income','expense','fixedIncome','fixedExpense','goals','loans','todos','history'].forEach(k=>{
      if(Array.isArray(p[k]))D[k]=p[k];
    });
    if(p.monthlyRecords)D.monthlyRecords=p.monthlyRecords;
    return true;
  }catch(e){return false;}
}

function sv(){
  saveToLS();
  if(saveTimeout)clearTimeout(saveTimeout);
  saveTimeout=setTimeout(()=>saveToFirestore(),1000);
}

function updateSyncUI(){
  const el=$('syncStatus');
  if(el){
    const labels={ok:'âœ“ ë™ê¸°í™”ë¨',ing:'âŸ³ ì €ì¥ì¤‘...',err:'âš  ì˜¤ë¥˜'};
    el.className='sync-status sync-'+syncStatus;
    el.textContent=labels[syncStatus];
  }
}

// ==================== Auth ====================
function showLoading(){
  $('cnt').innerHTML=`<div class="loading"><div class="spinner"></div><span style="color:var(--muted);font-size:12px">ë¡œë”© ì¤‘...</span></div>`;
}

function showLogin(){
  $('bnav').style.display='none';
  $('hdrRight').innerHTML='';
  $('cnt').innerHTML=`
    <div class="login-wrap">
      <h2>ğŸ’° ìì‚° ê´€ë¦¬</h2>
      <p>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë©´<br>ëª¨ë“  ê¸°ê¸°ì—ì„œ ë°ì´í„°ê°€ ë™ê¸°í™”ë©ë‹ˆë‹¤</p>
      <button class="btn btn-p" id="btnGoogleLogin">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
        Googleë¡œ ë¡œê·¸ì¸
      </button>
    </div>`;
  $('btnGoogleLogin').onclick=async()=>{
    try{
      const provider=new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    }catch(e){
      console.error('Login error:',e);
      toast('ë¡œê·¸ì¸ ì‹¤íŒ¨','âš ï¸');
    }
  };
}

function showApp(){
  $('bnav').style.display='flex';
  $('bnav').innerHTML=[['dash','ğŸ“Š','ëŒ€ì‹œë³´ë“œ'],['asset','ğŸ’°','ìì‚°'],['goal','ğŸ¯','ëª©í‘œ'],['todo','âœ…','í• ì¼'],['set','âš™ï¸','ì„¤ì •']].map(([k,i,n])=>`<button class="nav-i ${state.tab===k?'act':''}" data-t="${k}"><span class="ico">${i}</span>${n}</button>`).join('');
  $('bnav').onclick=e=>{const t=e.target.closest('.nav-i');if(t){state.tab=t.dataset.t;$$('.nav-i').forEach(n=>n.classList.toggle('act',n===t));rnd();}};
  
  const photoURL=currentUser?.photoURL||'';
  const displayName=currentUser?.displayName||currentUser?.email||'';
  $('hdrRight').innerHTML=`
    <span id="syncStatus" class="sync-status sync-ok">âœ“ ë™ê¸°í™”ë¨</span>
    <div class="hdr-user">
      ${photoURL?`<img src="${photoURL}" alt="">`:''}
      <span>${displayName.split(' ')[0]}</span>
    </div>
    <button class="btn btn-ic btn-o" id="btnTh">ğŸŒ“</button>`;
  $('btnTh').onclick=()=>{document.body.classList.toggle('light');localStorage.setItem('theme',isL()?'light':'dark');rnd();};
  rnd();
}

// Auth ìƒíƒœ ê°ì§€
auth.onAuthStateChanged(async user=>{
  currentUser=user;
  if(user){
    showLoading();
    const loaded=await loadFromFirestore();
    if(!loaded)loadFromLS();
    showApp();
  }else{
    showLogin();
  }
});

// ==================== í† ìŠ¤íŠ¸ ====================
function toast(m,i='ğŸ’¾',undo=false){
  $('toast').innerHTML=`<span>${i}</span> ${m}${undo?'<span class="hist-b" onclick="doUndo()">ë˜ëŒë¦¬ê¸°</span>':''}`;
  $('toast').classList.add('show');
  setTimeout(()=>$('toast').classList.remove('show'),undo?4e3:2500);
}
function setUndo(data,msg){undoData=data;toast(msg,'ğŸ—‘ï¸',true);}
function doUndo(){if(undoData){D=undoData;sv();rnd();toast('ë˜ëŒë¦¼ ì™„ë£Œ','â†©ï¸');undoData=null;}}

// ==================== ê³„ì‚° ====================
function calcLoan(P,rate,months,type,rem,remM){
  if(!P||!months)return{mp:0,mi:0};
  const r=rate/100/12,p=rem??P,n=remM||months;
  if(type==='bullet')return{mp:0,mi:Math.round(p*r)};
  if(type==='equal_principal')return{mp:Math.min(Math.round(p/n),p),mi:Math.round(p*r)};
  if(r===0)return{mp:Math.round(p/n),mi:0};
  const pmt=Math.round(p*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1)),mi=Math.round(p*r);
  return{mp:Math.min(Math.max(0,pmt-mi),p),mi};
}
function calcTotalInt(P,rate,months,type){
  if(!P||!months||rate<=0)return 0;
  const r=rate/100/12;
  if(type==='bullet')return Math.round(P*r*months);
  if(type==='equal_principal'){let t=0,rem=P;const mp=Math.round(P/months);for(let i=0;i<months&&rem>0;i++){t+=Math.round(rem*r);rem-=mp;}return t;}
  const pmt=Math.round(P*r*Math.pow(1+r,months)/(Math.pow(1+r,months)-1));
  return Math.max(0,pmt*months-P);
}

function calcMonthly(){
  const tm=gTM(),savings=D.assets.filter(a=>a.monthlyChange>0),loans=D.loans.filter(l=>(l.total||0)-(l.paid||0)>0);
  const tA=D.assets.reduce((s,a)=>s+(a.amount||0),0),debt=D.loans.reduce((s,l)=>s+Math.max(0,(l.total||0)-(l.paid||0)),0);
  const lastM=adjMonth(tm,-1),lastRec=D.monthlyRecords[lastM];
  return{tA,netA:tA-debt,debt,diff:lastRec?tA-lastRec.totalAsset:null,
    sTotal:savings.length,sDone:savings.filter(a=>a.lastDeposit===tm).length,
    lTotal:loans.length,lDone:loans.filter(l=>l.loanType==='bullet'?l.lastInterestPayment===tm:l.lastPayment===tm).length,
    sPending:savings.filter(a=>a.lastDeposit!==tm),lPending:loans.filter(l=>l.loanType==='bullet'?l.lastInterestPayment!==tm:l.lastPayment!==tm)};
}

function getLinked(gid){return gid?D.assets.filter(a=>a.goalId===gid):[];}
function updateGoal(gid,amt){const g=D.goals.find(x=>x.id===Number(gid));if(g){const prev=g.current||0;g.current=Math.max(0,prev+amt);if(prev<g.target&&g.current>=g.target)setTimeout(celebrate,300);}}
function addHist(type,name,amount,action,tid){D.history.unshift({id:genId(),date:localDate()+'T'+new Date().toTimeString().slice(0,8),type,name,amount,action,targetId:tid||null});if(D.history.length>200)D.history.pop();}

// ==================== ì•¡ì…˜ ====================
const actions={
  dep(id){const a=D.assets.find(x=>x.id===id),tm=gTM(),amt=a?.monthlyChange||0;if(!a||a.lastDeposit===tm)return toast('ì´ë¯¸ ì™„ë£Œ!','âš ï¸');if(!confirm(`${a.name}ì— ${fmtS(amt)} ì…ê¸ˆ?`))return;a.amount+=amt;a.lastDeposit=tm;D.expense.push({id:genId(),name:`ì €ì¶•:${a.name}`,amount:amt,targetId:id,auto:true,month:tm});addHist('deposit',a.name,amt,'ì…ê¸ˆ',id);if(a.goalId)updateGoal(a.goalId,amt);sv();rnd();toast(`${fmtS(amt)} ì…ê¸ˆ!`,'ğŸ’°');},
  cdep(id){const a=D.assets.find(x=>x.id===id),dm=a?.lastDeposit;if(!dm)return toast('ì·¨ì†Œ ë¶ˆê°€','âš ï¸');const h=D.history.find(x=>x.type==='deposit'&&x.targetId===id&&x.date?.startsWith(dm));if(!h||!confirm(`${a.name} ì…ê¸ˆ ì·¨ì†Œ?`))return;a.amount-=h.amount;D.expense=D.expense.filter(e=>!(e.targetId===id&&e.month===dm&&e.auto));D.history=D.history.filter(x=>x.id!==h.id);const prev=D.history.filter(x=>x.type==='deposit'&&x.targetId===id).sort((a,b)=>b.date.localeCompare(a.date))[0];a.lastDeposit=prev?.date.slice(0,7)||null;if(a.goalId)updateGoal(a.goalId,-h.amount);sv();rnd();toast('ì…ê¸ˆ ì·¨ì†Œ','â†©ï¸');},
  pay(id){const l=D.loans.find(x=>x.id===id),tm=gTM();if(!l||l.lastPayment===tm)return toast('ì´ë¯¸ ì™„ë£Œ!','âš ï¸');const rem=Math.max(0,(l.total||0)-(l.paid||0));if(rem<=0)return actions.complete(l);const lc=calcLoan(l.total,l.rate||0,diffMonth(l.startDate,l.endDate),l.loanType||'equal',rem,remainMonth(l.endDate));if(!confirm(`${l.name} ìƒí™˜\nì›ê¸ˆ: ${fmtS(lc.mp)}\nì´ì: ${fmtS(lc.mi)}\ní•©ê³„: ${fmtS(lc.mp+lc.mi)}`))return;if(lc.mp>0){l.paid+=lc.mp;D.expense.push({id:genId(),name:`ì›ê¸ˆ:${l.name}`,amount:lc.mp,targetId:id,auto:true,month:tm});addHist('payment',l.name,lc.mp,'ì›ê¸ˆ',id);}if(lc.mi>0){D.expense.push({id:genId(),name:`ì´ì:${l.name}`,amount:lc.mi,targetId:id,auto:true,month:tm});addHist('interest',l.name,lc.mi,'ì´ì',id);}l.lastPayment=tm;sv();rnd();if((l.total||0)-(l.paid||0)<=0)setTimeout(()=>actions.complete(l),500);else toast('ìƒí™˜ ì™„ë£Œ!','ğŸ’¸');},
  cpay(id){const l=D.loans.find(x=>x.id===id),pm=l?.lastPayment;if(!pm)return toast('ì·¨ì†Œ ë¶ˆê°€','âš ï¸');const h=D.history.find(x=>x.type==='payment'&&x.targetId===id&&x.date?.startsWith(pm));if(!h||!confirm(`${l.name} ìƒí™˜ ì·¨ì†Œ?`))return;l.paid-=h.amount;D.expense=D.expense.filter(e=>!(e.targetId===id&&e.month===pm&&e.auto));D.history=D.history.filter(x=>!(x.targetId===id&&x.date?.startsWith(pm)));const prev=D.history.filter(x=>x.type==='payment'&&x.targetId===id).sort((a,b)=>b.date.localeCompare(a.date))[0];l.lastPayment=prev?.date.slice(0,7)||null;sv();rnd();toast('ìƒí™˜ ì·¨ì†Œ','â†©ï¸');},
  int(id){const l=D.loans.find(x=>x.id===id),tm=gTM();if(!l||l.lastInterestPayment===tm)return toast('ì´ë¯¸ ì™„ë£Œ!','âš ï¸');const lc=calcLoan(l.total,l.rate||0,diffMonth(l.startDate,l.endDate),'bullet',Math.max(0,(l.total||0)-(l.paid||0)));if(!confirm(`${l.name} ì´ì ë‚©ë¶€\nì´ì: ${fmtS(lc.mi)}`))return;D.expense.push({id:genId(),name:`ì´ì:${l.name}`,amount:lc.mi,targetId:id,auto:true,month:tm});addHist('interest',l.name,lc.mi,'ì´ì',id);l.lastInterestPayment=tm;sv();rnd();toast('ì´ì ë‚©ë¶€ ì™„ë£Œ!','ğŸ’µ');},
  cint(id){const l=D.loans.find(x=>x.id===id),im=l?.lastInterestPayment;if(!im)return toast('ì·¨ì†Œ ë¶ˆê°€','âš ï¸');const h=D.history.find(x=>x.type==='interest'&&x.targetId===id&&x.date?.startsWith(im));if(!h||!confirm(`${l.name} ì´ì ì·¨ì†Œ?`))return;D.expense=D.expense.filter(e=>!(e.targetId===id&&e.month===im&&e.auto&&e.name.startsWith('ì´ì:')));D.history=D.history.filter(x=>x.id!==h.id);const prev=D.history.filter(x=>x.type==='interest'&&x.targetId===id).sort((a,b)=>b.date.localeCompare(a.date))[0];l.lastInterestPayment=prev?.date.slice(0,7)||null;sv();rnd();toast('ì´ì ì·¨ì†Œ','â†©ï¸');},
  bpay(id){const l=D.loans.find(x=>x.id===id),rem=Math.max(0,(l?.total||0)-(l?.paid||0));if(!rem)return;if(!confirm(`${l.name} ë§Œê¸° ì¼ì‹œìƒí™˜\nì›ê¸ˆ: ${fmtS(rem)}`))return;const tm=gTM();l.paid=l.total;l.bulletPaidAmount=rem;D.expense.push({id:genId(),name:`ì›ê¸ˆ:${l.name}`,amount:rem,targetId:id,auto:true,month:tm});addHist('payment',l.name,rem,'ì›ê¸ˆ(ë§Œê¸°)',id);l.lastPayment=tm;sv();rnd();toast('ì›ê¸ˆ ìƒí™˜ ì™„ë£Œ!','ğŸ’¸');},
  cbpay(id){const l=D.loans.find(x=>x.id===id),pm=l?.lastPayment;if(!pm)return toast('ì·¨ì†Œ ë¶ˆê°€','âš ï¸');const h=D.history.find(x=>x.type==='payment'&&x.targetId===id&&x.date?.startsWith(pm));if(!h||!confirm(`${l.name} ì›ê¸ˆìƒí™˜ ì·¨ì†Œ?`))return;l.paid-=l.bulletPaidAmount||h.amount;l.bulletPaidAmount=null;D.expense=D.expense.filter(e=>!(e.targetId===id&&e.month===pm&&e.auto&&e.name.startsWith('ì›ê¸ˆ:')));D.history=D.history.filter(x=>x.id!==h.id);const prev=D.history.filter(x=>x.type==='payment'&&x.targetId===id).sort((a,b)=>b.date.localeCompare(a.date))[0];l.lastPayment=prev?.date.slice(0,7)||null;sv();rnd();toast('ì›ê¸ˆìƒí™˜ ì·¨ì†Œ','â†©ï¸');},
  complete(l){if(!confirm(`${l.name} ì™„ë‚©! ì‚­ì œ?`))return;D.expense=D.expense.filter(e=>e.targetId!==l.id);D.history=D.history.filter(h=>h.targetId!==l.id);D.loans=D.loans.filter(x=>x.id!==l.id);addHist('loanComplete',l.name,l.total,'ì™„ë‚©',null);sv();rnd();toast(`${l.name} ì™„ë‚©!`,'ğŸ‰');setTimeout(celebrate,300);},
  mat(id){const a=D.assets.find(x=>x.id===id);if(!a||!confirm(`${a.name} ë§Œê¸°!\n${fmtS(a.amount)}ì„ í˜„ê¸ˆìœ¼ë¡œ ì „í™˜?`))return;if(a.goalId)updateGoal(a.goalId,-a.amount);D.expense=D.expense.filter(e=>e.targetId!==id);D.history=D.history.filter(h=>h.targetId!==id);D.assets=D.assets.filter(x=>x.id!==id);D.assets.push({id:genId(),name:'ë§Œê¸°ìê¸ˆ_'+a.name,category:'í˜„ê¸ˆ',amount:a.amount,monthlyChange:0});addHist('maturity',a.name,a.amount,'ë§Œê¸°ì „í™˜',null);sv();rnd();toast(`${a.name} â†’ í˜„ê¸ˆ`,'ğŸŠ');setTimeout(celebrate,300);}
};

function celebrate(){const cv=$('conf'),ctx=cv.getContext('2d');cv.width=innerWidth;cv.height=innerHeight;const ps=[];for(let i=0;i<100;i++)ps.push({x:cv.width/2,y:cv.height/2,vx:(Math.random()-.5)*15,vy:(Math.random()-.5)*15-5,c:gc()[i%5],sz:Math.random()*8+4,l:1});(function ani(){ctx.clearRect(0,0,cv.width,cv.height);let alive=false;ps.forEach(p=>{if(p.l<=0)return;alive=true;p.x+=p.vx;p.y+=p.vy;p.vy+=.3;p.l-=.015;ctx.globalAlpha=p.l;ctx.fillStyle=p.c;ctx.beginPath();ctx.arc(p.x,p.y,p.sz,0,Math.PI*2);ctx.fill();});if(alive)requestAnimationFrame(ani);else ctx.clearRect(0,0,cv.width,cv.height);})();}

// ==================== ë Œë”ë§ í—¬í¼ ====================
const h={
  stat:(l,v,s,cls='')=>`<div class="stat ${cls}"><div class="stat-l">${l}</div><div class="stat-v">${v}</div>${s?`<div class="stat-s">${s}</div>`:''}</div>`,
  tabs:(items,cur,key)=>items.map(([k,v])=>`<button class="tab ${cur===k?'act':''}" data-${key}="${k}">${v}</button>`).join(''),
  prog:(pct,done)=>`<div class="prog"><div class="prog-f" style="width:${pct}%;background:${gpc(done?'suc':'pri')}"></div></div>`,
  badge:(t,cls)=>`<span class="badge badge-${cls}">${t}</span>`,
  empty:(ico,t,btn)=>`<div class="no-item">${ico?`<div style="font-size:40px;margin-bottom:10px">${ico}</div>`:''}${t}${btn||''}</div>`
};

// ==================== ë Œë”ëŸ¬ ====================
const renders={
  dash(){
    const m=calcMonthly(),ml=gML(),pending=[],todos=D.todos.filter(t=>!t.done).slice(0,3);
    m.sPending.forEach(a=>pending.push({t:'sav',id:a.id,n:a.name,amt:a.monthlyChange}));
    m.lPending.forEach(l=>{const rem=(l.total||0)-(l.paid||0),lc=calcLoan(l.total,l.rate||0,diffMonth(l.startDate,l.endDate),l.loanType||'equal',rem,remainMonth(l.endDate));pending.push({t:l.loanType==='bullet'?'int':'loan',id:l.id,n:l.name,amt:l.loanType==='bullet'?lc.mi:lc.mp+lc.mi});});
    
    let o=D.assets.length===0&&D.goals.length===0?`<div class="guide"><div class="guide-t">ğŸ‘‹ ì‹œì‘í•˜ê¸°</div><div class="guide-d">1. ìì‚° íƒ­ì—ì„œ ì˜ˆê¸ˆ/ì ê¸ˆ ë“±ë¡<br>2. ëª©í‘œë¥¼ ì„¤ì •í•˜ê³  ìì‚° ì—°ë™</div><button class="btn" data-add="asset">+ ì²« ìì‚° ì¶”ê°€</button></div>`:'';
    o+=`<div class="g4">${h.stat('ğŸ’µ ì´ìì‚°',fmtS(m.tA),m.diff!==null?`<span style="color:${m.diff>=0?gpc('suc'):gpc('dan')}">${m.diff>=0?'â–²':'â–¼'}${fmtS(Math.abs(m.diff))}</span>`:'')}${h.stat('ğŸ’ ìˆœìì‚°',`<span style="color:${m.netA>=0?gpc('suc'):gpc('dan')}">${fmtS(m.netA)}</span>`,m.debt>0?'ëŒ€ì¶œ -'+fmtS(m.debt):'')}${h.stat('ğŸ¦ ì ê¸ˆ',`${m.sDone}/${m.sTotal}`,m.sTotal===0?'ì—†ìŒ':m.sDone===m.sTotal?'ì™„ë£Œ!':m.sTotal-m.sDone+'ê±´',m.sTotal===0?'':m.sDone===m.sTotal?'done':'pending')}${h.stat('ğŸ’¸ ëŒ€ì¶œ',`${m.lDone}/${m.lTotal}`,m.lTotal===0?'ì—†ìŒ':m.lDone===m.lTotal?'ì™„ë£Œ!':m.lTotal-m.lDone+'ê±´',m.lTotal===0?'':m.lDone===m.lTotal?'done':'pending')}</div>`;
    if(pending.length)o+=`<div class="card"><div class="card-t">â³ ${ml} ë¯¸ì™„ë£Œ</div>${pending.map(p=>`<div class="li"><div class="li-i"><div class="li-n">${p.n}</div><div class="li-sub">${{sav:'ì ê¸ˆ',int:'ì´ì',loan:'ìƒí™˜'}[p.t]} Â· ${fmtS(p.amt)}</div></div><button class="btn btn-p btn-xs" data-q="${p.t}" data-qid="${p.id}">${{sav:'ğŸ’°',int:'ğŸ’µ',loan:'ğŸ’¸'}[p.t]}</button></div>`).join('')}</div>`;
    if(todos.length)o+=`<div class="card"><div class="card-t">âœ… í• ì¼</div>${todos.map(t=>`<div class="li"><div class="todo-check" data-tog="${t.id}"></div><span style="font-size:12px">${t.text}</span></div>`).join('')}</div>`;
    o+=`<div class="card"><div class="card-t">ìì‚° êµ¬ì„±</div><div class="chart-box"><canvas id="aChart"></canvas></div>${D.assets.length?D.assets.slice(0,5).map((a,i)=>`<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:12px;${i<Math.min(D.assets.length,5)-1?'border-bottom:1px solid var(--brd)':''}"><span style="color:var(--muted)">${a.name}</span><span style="font-weight:600">${fmtS(a.amount||0)}</span></div>`).join(''):'<div class="no-item">ìì‚°ì„ ì¶”ê°€í•˜ì„¸ìš”</div>'}</div>`;
    o+=`<div class="card"><div class="card-t"><span>ìì‚° ì¶”ì´</span><div style="display:flex;gap:4px"><button class="btn btn-xs ${state.trendView==='month'?'btn-p':'btn-o'}" data-tv="month">ì›”ë³„</button><button class="btn btn-xs ${state.trendView==='year'?'btn-p':'btn-o'}" data-tv="year">ì—°ë³„</button><button class="btn btn-xs btn-o" id="btnSaveM">ğŸ“¸</button></div></div><div class="trend"><canvas id="tChart"></canvas></div></div>`;
    o+=`<div class="card"><div class="card-t">ëª©í‘œ <button class="btn btn-xs btn-p" data-add="goal">+ ì¶”ê°€</button></div>${D.goals.length?D.goals.slice(0,3).map(g=>{const pct=Math.min(100,(g.current||0)/(g.target||1)*100),done=pct>=100;return`<div class="gc ${done?'done':''}"><div class="gc-h"><span class="gc-n">${done?'ğŸ‰ ':''}${g.name}</span><span style="font-weight:700;color:var(--pri)">${pct.toFixed(0)}%</span></div>${h.prog(pct,done)}<div class="gc-i"><span>${fmtS(g.current||0)} / ${fmtS(g.target||0)}</span></div></div>`;}).join(''):'<div class="no-item">ëª©í‘œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”</div>'}</div>`;
    return o;
  },
  asset(){
    const tm=gTM(),ml=gML(),{aTab,flowMonth,assetSort,assetFilter}=state;
    if(aTab==='list'){
      let assets=[...D.assets];const cats=['all',...new Set(D.assets.map(a=>a.category).filter(Boolean))];
      if(assetFilter!=='all')assets=assets.filter(a=>a.category===assetFilter);
      if(assetSort==='name')assets.sort((a,b)=>a.name.localeCompare(b.name));
      else if(assetSort==='amount')assets.sort((a,b)=>(b.amount||0)-(a.amount||0));
      return`<div class="tabs">${h.tabs([['list','ìì‚°'],['flow','ìˆ˜ì…/ì§€ì¶œ'],['fixed','ê³ ì •'],['monthly','ì›”ë³„']],aTab,'at')}</div><div class="card"><div class="card-t">ìì‚° ëª©ë¡ <button class="btn btn-xs btn-p" data-add="asset">+ ì¶”ê°€</button></div><div class="filter-row"><select id="assetSort"><option value="order">ê¸°ë³¸ìˆœ</option><option value="name" ${assetSort==='name'?'selected':''}>ì´ë¦„ìˆœ</option><option value="amount" ${assetSort==='amount'?'selected':''}>ê¸ˆì•¡ìˆœ</option></select><select id="assetFilter"><option value="all">ì „ì²´</option>${cats.filter(c=>c!=='all').map(c=>`<option value="${c}" ${assetFilter===c?'selected':''}>${c}</option>`).join('')}</select></div>${assets.length?assets.map(a=>{const hm=a.monthlyChange>0,dep=a.lastDeposit===tm,mat=a.maturityDate&&isMatured(a.maturityDate),gn=a.goalId?D.goals.find(g=>g.id===a.goalId)?.name:null;let act='';if(mat)act=`<button class="btn btn-p btn-xs" data-mat="${a.id}">ğŸŠ ë§Œê¸°</button>`;else if(hm)act=dep?`<span class="dep-d">âœ… ${ml}</span><span class="hist-b" data-cdep="${a.id}">ì·¨ì†Œ</span>`:`<button class="btn btn-p btn-xs" data-dep="${a.id}">ğŸ’° ì…ê¸ˆ</button>${a.lastDeposit?`<span class="hist-b" data-cdep="${a.id}">ì´ì „ì·¨ì†Œ</span>`:''}`;return`<div class="li"><div class="li-i"><div class="li-n">${a.name}${mat?h.badge('ë§Œê¸°!','warn'):''}${gn?h.badge('ğŸ¯'+gn,'suc'):''}</div><div class="li-sub">${a.category||''}${hm?` Â· +${fmtS(a.monthlyChange)}/ì›”`:''}${a.maturityDate?` Â· ~${fmtDate(a.maturityDate)}`:''}</div></div><div class="li-v">${fmtS(a.amount||0)}</div><button class="btn btn-g" data-edit="asset" data-id="${a.id}">âœï¸</button>${act?`<div class="li-acts">${act}</div>`:''}</div>`;}).join(''):h.empty('ğŸ’°','ìì‚°ì„ ì¶”ê°€í•˜ì„¸ìš”',`<button class="btn btn-p btn-sm" data-add="asset">+ ì¶”ê°€</button>`)}</div>`;
    }
    if(aTab==='flow'){
      const mInc=D.income.filter(i=>i.month===flowMonth),mExp=D.expense.filter(e=>e.month===flowMonth&&!e.auto),mExpF=D.expense.filter(e=>e.month===flowMonth&&e.autoFixed),autoAmt=D.expense.filter(e=>e.month===flowMonth&&e.auto&&!e.autoFixed).reduce((s,e)=>s+(e.amount||0),0);
      const tInc=mInc.reduce((s,i)=>s+(i.amount||0),0),tExp=mExp.reduce((s,e)=>s+(e.amount||0),0)+mExpF.reduce((s,e)=>s+(e.amount||0),0)+autoAmt;
      return`<div class="tabs">${h.tabs([['list','ìì‚°'],['flow','ìˆ˜ì…/ì§€ì¶œ'],['fixed','ê³ ì •'],['monthly','ì›”ë³„']],aTab,'at')}</div><div class="month-sel"><button class="btn btn-o" id="prevM">â—€</button><input type="month" id="flowM" value="${flowMonth}"><button class="btn btn-o" id="nextM">â–¶</button><button class="btn btn-o btn-xs" id="applyFixed">ğŸ“Œê³ ì •</button></div><div class="card" style="padding:10px 12px;display:flex;justify-content:space-between"><span style="font-size:12px">ìˆœìˆ˜ìµ</span><span style="font-weight:700;color:${tInc-tExp>=0?gpc('suc'):gpc('dan')}">${tInc-tExp>=0?'+':''}${fmtS(tInc-tExp)}</span></div><div class="card"><div class="card-t">ìˆ˜ì… <button class="btn btn-xs btn-p" data-add="income">+</button></div><div style="font-size:1.1rem;font-weight:700;color:${gpc('suc')};margin-bottom:8px">+${fmtS(tInc)}</div>${mInc.length?mInc.map(i=>`<div class="li"><span style="font-size:12px">${i.name}${i.fixedId?h.badge('ê³ ì •','fixed'):''}</span><div style="display:flex;align-items:center;gap:4px"><span style="color:${gpc('suc')};font-size:12px">${fmtS(i.amount)}</span><button class="btn btn-g" data-edit="income" data-id="${i.id}">âœï¸</button></div></div>`).join(''):'<div class="no-item">ì—†ìŒ</div>'}</div><div class="card"><div class="card-t">ì§€ì¶œ <button class="btn btn-xs btn-p" data-add="expense">+</button></div><div style="font-size:1.1rem;font-weight:700;color:${gpc('dan')};margin-bottom:8px">-${fmtS(tExp)}</div>${autoAmt?`<div style="font-size:10px;color:var(--muted);margin-bottom:6px">ì €ì¶•/ìƒí™˜ ${fmtS(autoAmt)}</div>`:''}${[...mExpF,...mExp].map(e=>`<div class="li"><span style="font-size:12px">${e.name}${e.autoFixed?h.badge('ê³ ì •','fixed'):''}</span><div style="display:flex;align-items:center;gap:4px"><span style="color:${gpc('dan')};font-size:12px">${fmtS(e.amount)}</span><button class="btn btn-g" data-edit="expense" data-id="${e.id}">âœï¸</button></div></div>`).join('')||'<div class="no-item">ì—†ìŒ</div>'}</div>`;
    }
    if(aTab==='fixed'){
      return`<div class="tabs">${h.tabs([['list','ìì‚°'],['flow','ìˆ˜ì…/ì§€ì¶œ'],['fixed','ê³ ì •'],['monthly','ì›”ë³„']],aTab,'at')}</div><div class="card"><div class="card-t">ê³ ì • ìˆ˜ì… <button class="btn btn-xs btn-p" data-add="fixedIncome">+</button></div>${D.fixedIncome.length?D.fixedIncome.map(f=>{const la=f.linkedAssetId?D.assets.find(a=>a.id===f.linkedAssetId):null;return`<div class="li"><div class="li-i"><div class="li-n" style="font-size:12px">${f.name}${la?h.badge('â†’'+la.name,'pri'):''}</div><div class="li-sub">${f.category||''} Â· ë§¤ì›” ${f.dueDate||1}ì¼</div></div><span style="color:${gpc('suc')};font-weight:600;font-size:12px">+${fmtS(f.amount)}</span><button class="btn btn-g" data-edit="fixedIncome" data-id="${f.id}">âœï¸</button></div>`;}).join(''):'<div class="no-item">ì—†ìŒ</div>'}</div><div class="card"><div class="card-t">ê³ ì • ì§€ì¶œ <button class="btn btn-xs btn-p" data-add="fixedExpense">+</button></div>${D.fixedExpense.length?D.fixedExpense.map(f=>{const la=f.linkedAssetId?D.assets.find(a=>a.id===f.linkedAssetId):null;return`<div class="li"><div class="li-i"><div class="li-n" style="font-size:12px">${f.name}${la?h.badge('â†'+la.name,'warn'):''}</div><div class="li-sub">${f.category||''} Â· ë§¤ì›” ${f.dueDate||1}ì¼</div></div><span style="color:${gpc('dan')};font-weight:600;font-size:12px">-${fmtS(f.amount)}</span><button class="btn btn-g" data-edit="fixedExpense" data-id="${f.id}">âœï¸</button></div>`;}).join(''):'<div class="no-item">ì—†ìŒ</div>'}</div><div class="link-info">ğŸ’¡ ìì‚° ì—°ê²° ì‹œ ğŸ“Œê³ ì • ë°˜ì˜í•˜ë©´ ì”ì•¡ ìë™ ë³€ë™</div>`;
    }
    const recs=Object.entries(D.monthlyRecords).sort((a,b)=>b[0].localeCompare(a[0]));
    return`<div class="tabs">${h.tabs([['list','ìì‚°'],['flow','ìˆ˜ì…/ì§€ì¶œ'],['fixed','ê³ ì •'],['monthly','ì›”ë³„']],aTab,'at')}</div><div class="card"><div class="card-t">ì›”ë³„ ê¸°ë¡ <button class="btn btn-xs btn-p" id="btnSaveM2">ğŸ“¸ ì €ì¥</button></div>${recs.length?recs.map(([m,r])=>`<div style="background:var(--bg);border-radius:8px;padding:10px;border:1px solid var(--brd);margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-weight:600;font-size:12px">${m}</span><button class="btn btn-g" data-delm="${m}" style="padding:2px">ğŸ—‘ï¸</button></div><div style="font-size:11px;display:grid;grid-template-columns:1fr 1fr;gap:3px"><div style="display:flex;justify-content:space-between"><span>ì´ìì‚°</span><span style="color:${gpc('pri')}">${fmtS(r.totalAsset||0)}</span></div><div style="display:flex;justify-content:space-between"><span>ìˆœìì‚°</span><span style="color:${(r.netAsset||0)>=0?gpc('suc'):gpc('dan')}">${fmtS(r.netAsset||0)}</span></div></div></div>`).join(''):'<div class="no-item">ğŸ“¸ ë²„íŠ¼ìœ¼ë¡œ ê¸°ë¡ ì €ì¥</div>'}</div>`;
  },
  goal(){
    const tm=gTM(),ml=gML(),{gTab,goalSort,loanSort}=state;
    if(gTab==='goals'){
      let goals=[...D.goals];
      if(goalSort==='name')goals.sort((a,b)=>a.name.localeCompare(b.name));
      else if(goalSort==='progress')goals.sort((a,b)=>((b.current||0)/(b.target||1))-((a.current||0)/(a.target||1)));
      return`<div class="tabs">${h.tabs([['goals','ëª©í‘œ'],['loans','ëŒ€ì¶œ']],gTab,'gt')}</div><div class="card"><div class="card-t">ëª©í‘œ <button class="btn btn-xs btn-p" data-add="goal">+ ì¶”ê°€</button></div><div class="filter-row"><select id="goalSort"><option value="order">ê¸°ë³¸ìˆœ</option><option value="name" ${goalSort==='name'?'selected':''}>ì´ë¦„ìˆœ</option><option value="progress" ${goalSort==='progress'?'selected':''}>ì§„í–‰ë¥ </option></select></div>${goals.length?goals.map(g=>{const pct=Math.min(100,(g.current||0)/(g.target||1)*100),done=pct>=100,linked=getLinked(g.id);return`<div class="gc ${done?'done':''}"><div class="gc-h"><span class="gc-n">${done?'ğŸ‰ ':''}${g.name}${linked.length?h.badge('ì—°ë™ '+linked.length,'suc'):''}</span><button class="btn btn-g" data-edit="goal" data-id="${g.id}">âœï¸</button></div>${h.prog(pct,done)}<div class="gc-i"><span>${fmtS(g.current||0)} / ${fmtS(g.target||0)}</span><span>${pct.toFixed(0)}%${g.deadline?' Â· '+fmtDate(g.deadline):''}</span></div>${linked.length?`<div class="link-info">ğŸ”— ${linked.map(a=>a.name+'('+fmtS(a.amount)+')').join(', ')}</div>`:''}</div>`;}).join(''):h.empty('ğŸ¯','ëª©í‘œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”',`<button class="btn btn-p btn-sm" data-add="goal">+ ì¶”ê°€</button>`)}</div>`;
    }
    let loans=[...D.loans];
    if(loanSort==='amount')loans.sort((a,b)=>(b.total||0)-(a.total||0));
    else if(loanSort==='remain')loans.sort((a,b)=>((b.total||0)-(b.paid||0))-((a.total||0)-(a.paid||0)));
    return`<div class="tabs">${h.tabs([['goals','ëª©í‘œ'],['loans','ëŒ€ì¶œ']],gTab,'gt')}</div><div class="card"><div class="card-t">ëŒ€ì¶œ <button class="btn btn-xs btn-p" data-add="loan">+ ì¶”ê°€</button></div><div class="filter-row"><select id="loanSort"><option value="order">ê¸°ë³¸ìˆœ</option><option value="amount" ${loanSort==='amount'?'selected':''}>ê¸ˆì•¡ìˆœ</option><option value="remain" ${loanSort==='remain'?'selected':''}>ì”ì•¡ìˆœ</option></select></div>${loans.length?loans.map(l=>{const rem=Math.max(0,(l.total||0)-(l.paid||0)),done=rem<=0,pct=(l.total||0)>0?(l.paid||0)/(l.total)*100:0,months=diffMonth(l.startDate,l.endDate),remM=remainMonth(l.endDate),lc=calcLoan(l.total,l.rate||0,months,l.loanType||'equal',rem,remM),totalInt=calcTotalInt(l.total,l.rate||0,months,l.loanType||'equal'),isBullet=l.loanType==='bullet',intDone=l.lastInterestPayment===gTM(),payDone=l.lastPayment===gTM(),exp=expandedLoans.has(l.id);
    let act='';if(done)act=l.lastPayment?`<span class="dep-d">âœ… ì™„ë‚©</span><span class="hist-b" data-${isBullet?'cbpay':'cpay'}="${l.id}">ì·¨ì†Œ</span>`:`<button class="btn btn-d btn-xs" data-delloan="${l.id}">ğŸ—‘ï¸</button>`;
    else if(isBullet){act=intDone?`<span class="dep-d">âœ… ${gML()}</span><span class="hist-b" data-cint="${l.id}">ì·¨ì†Œ</span>`:lc.mi>0?`<button class="btn btn-p btn-xs" data-int="${l.id}">ğŸ’µ ${fmtS(lc.mi)}</button>`:'';if(remM<=1)act+=`<button class="btn btn-w btn-xs" data-bpay="${l.id}">ğŸ¦ ì›ê¸ˆ</button>`;}
    else act=payDone?`<span class="dep-d">âœ… ${gML()}</span><span class="hist-b" data-cpay="${l.id}">ì·¨ì†Œ</span>`:`<button class="btn btn-p btn-xs" data-pay="${l.id}">ğŸ’¸ ${fmtS(lc.mp+lc.mi)}</button>`;
    return`<div class="gc ${done?'done':''}"><div class="gc-h"><span class="gc-n">${done?'ğŸ‰ ':''}${l.name}${isBullet?h.badge('ë§Œê¸°','pri'):''}</span><div style="display:flex;gap:4px"><button class="expand-btn" data-expand="${l.id}">${exp?'â–²':'â–¼'}</button><button class="btn btn-g" data-edit="loan" data-id="${l.id}">âœï¸</button></div></div>${h.prog(pct,true)}<div class="gc-i"><span>${done?'ì™„ë‚©':'ì”ì•¡ '+fmtS(rem)}</span><span>${pct.toFixed(0)}%</span></div><div class="gc-detail ${exp?'open':''}"><div class="loan-info"><div>ğŸ“‹ ${{equal:'ì›ë¦¬ê¸ˆê· ë“±',equal_principal:'ì›ê¸ˆê· ë“±',bullet:'ë§Œê¸°ì¼ì‹œ'}[l.loanType]||'ì›ë¦¬ê¸ˆê· ë“±'} Â· ì—° ${l.rate||0}%</div><div>ğŸ“… ${fmtDate(l.startDate)}~${fmtDate(l.endDate)} (${remM}ê°œì›”)</div><div>ğŸ’µ ì›”: ${isBullet?'ì´ì '+fmtS(lc.mi):'ì›ê¸ˆ'+fmtS(lc.mp)+'+ì´ì'+fmtS(lc.mi)}</div><div>ğŸ’° ì´ ì´ì: <span style="color:${gpc('warn')}">${fmtS(totalInt)}</span></div></div></div><div class="li-acts" style="margin-top:8px">${act}</div></div>`;}).join(''):h.empty('ğŸ‘','ëŒ€ì¶œ ì—†ìŒ')}</div>`;
  },
  todo(){
    const{tTab}=state;let todos=[...D.todos];
    if(tTab==='active')todos=todos.filter(t=>!t.done);
    else if(tTab==='done')todos=todos.filter(t=>t.done);
    const ac=D.todos.filter(t=>!t.done).length,dc=D.todos.filter(t=>t.done).length;
    return`<div class="tabs">${h.tabs([['all','ì „ì²´ ('+D.todos.length+')'],['active','ì§„í–‰ ('+ac+')'],['done','ì™„ë£Œ ('+dc+')']],tTab,'tt')}</div><div class="card"><div class="card-t">í• ì¼ ê´€ë¦¬</div><div class="todo-input"><input type="text" id="todoInput" placeholder="ìƒˆ í• ì¼ ì…ë ¥..." maxlength="100"><button class="btn btn-p btn-sm" id="btnAddTodo">ì¶”ê°€</button></div>${todos.length?todos.map(t=>`<div class="todo-item ${t.done?'done':''}"><div class="todo-check ${t.done?'checked':''}" data-tog="${t.id}">${t.done?'âœ“':''}</div><div style="flex:1"><div class="todo-text">${t.text}</div></div><button class="todo-del" data-dtodo="${t.id}">ğŸ—‘ï¸</button></div>`).join(''):`<div class="no-item">${tTab==='done'?'ì™„ë£Œëœ í• ì¼ ì—†ìŒ':tTab==='active'?'ëª¨ë‘ ì™„ë£Œ! ğŸ‰':'í• ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”'}</div>`}</div>${dc>0?`<div class="card" style="padding:8px 12px;display:flex;justify-content:space-between"><span style="font-size:11px;color:var(--muted)">ì™„ë£Œ ${dc}ê°œ</span><button class="btn btn-xs btn-o" id="btnClearDone">ì •ë¦¬</button></div>`:''}`;
  },
  set(){
    return`<div class="set-card"><h4>ğŸ‘¤ ê³„ì •</h4><div class="set-row"><span style="font-size:12px">${currentUser?.email||''}</span><button class="btn btn-o btn-xs" id="btnLogout">ë¡œê·¸ì•„ì›ƒ</button></div></div><div class="set-card"><h4>ğŸ¨ í…Œë§ˆ</h4><div style="display:flex;gap:8px;margin-top:6px"><button class="btn btn-sm ${!isL()?'btn-p':'btn-o'}" id="thD">ğŸŒ™ ë‹¤í¬</button><button class="btn btn-sm ${isL()?'btn-p':'btn-o'}" id="thL">â˜€ï¸ ë¼ì´íŠ¸</button></div></div><div class="set-card"><h4>ğŸ’¾ ë°ì´í„°</h4><div class="set-row"><span style="font-size:12px">ë‚´ë³´ë‚´ê¸°</span><button class="btn btn-o btn-xs" id="btnExp">ğŸ“¤</button></div><div class="set-row"><span style="font-size:12px">ê°€ì ¸ì˜¤ê¸°</span><label class="btn btn-o btn-xs">ğŸ“¥<input type="file" accept=".json" id="fImp" hidden></label></div><div class="set-row"><span style="font-size:12px;color:var(--dan)">ì´ˆê¸°í™”</span><button class="btn btn-d btn-xs" id="btnRst">ğŸ—‘ï¸</button></div><div class="set-desc">â˜ï¸ ë°ì´í„°ëŠ” Google ê³„ì •ì— ìë™ ë™ê¸°í™”ë©ë‹ˆë‹¤</div></div><div class="set-card"><h4>â„¹ï¸ ì •ë³´</h4><div class="set-row"><span style="font-size:12px">ë²„ì „</span><span style="color:var(--muted);font-size:11px">v1.0</span></div></div>`;
  }
};

// ==================== ë©”ì¸ ë Œë” ====================
function rnd(){
  $('cnt').innerHTML=renders[state.tab]();
  bindEv();
  if(state.tab==='dash'){setTimeout(rChart,50);setTimeout(rTrend,100);}
}

function rChart(){const ctx=$('aChart');if(!ctx)return;if(chart)chart.destroy();const byC={};D.assets.forEach(a=>{byC[a.category||'ê¸°íƒ€']=(byC[a.category||'ê¸°íƒ€']||0)+(a.amount||0);});if(!Object.keys(byC).length)return;chart=new Chart(ctx,{type:'doughnut',data:{labels:Object.keys(byC),datasets:[{data:Object.values(byC),backgroundColor:gc(),borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:getComputedStyle(document.body).getPropertyValue('--text').trim(),boxWidth:10,font:{size:10}}}},cutout:'55%'}});}

function rTrend(){const ctx=$('tChart');if(!ctx)return;if(trend)trend.destroy();const all=Object.entries(D.monthlyRecords).sort((a,b)=>a[0].localeCompare(b[0]));let labels=[],vals=[];if(state.trendView==='year'){const byY={};all.forEach(([m,r])=>{byY[m.slice(0,4)]=r.totalAsset||0;});const yrs=Object.keys(byY).sort();if(yrs.length<2)return;labels=yrs.map(y=>y+'ë…„');vals=yrs.map(y=>byY[y]);}else{const recs=all.slice(-12);if(recs.length<2){ctx.parentElement.innerHTML='<div class="no-item">ğŸ“¸ ë²„íŠ¼ìœ¼ë¡œ ê¸°ë¡ ì €ì¥</div>';return;}labels=recs.map(([m])=>m.slice(2).replace('-','.'));vals=recs.map(([,r])=>r.totalAsset||0);}trend=new Chart(ctx,{type:'line',data:{labels,datasets:[{data:vals,borderColor:gpc('pri'),backgroundColor:gpc('pri')+'33',fill:true,tension:.4,pointRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{color:'#94a3b8',font:{size:9}}},y:{grid:{color:'#334155'},ticks:{color:'#94a3b8',font:{size:9},callback:v=>fmtS(v)}}}}});}

// ==================== ì´ë²¤íŠ¸ ë°”ì¸ë”© ====================
function bindEv(){
  const on=(sel,fn)=>$$(sel).forEach(el=>el.onclick=e=>fn(el,e));
  on('[data-at]',el=>{state.aTab=el.dataset.at;rnd();});
  on('[data-gt]',el=>{state.gTab=el.dataset.gt;rnd();});
  on('[data-tt]',el=>{state.tTab=el.dataset.tt;rnd();});
  on('[data-tv]',el=>{state.trendView=el.dataset.tv;rnd();});
  on('[data-add]',el=>openM(el.dataset.add));
  on('[data-edit]',el=>openM(el.dataset.edit,+el.dataset.id));
  on('[data-dep]',el=>actions.dep(+el.dataset.dep));
  on('[data-cdep]',el=>actions.cdep(+el.dataset.cdep));
  on('[data-mat]',el=>actions.mat(+el.dataset.mat));
  on('[data-pay]',el=>actions.pay(+el.dataset.pay));
  on('[data-cpay]',el=>actions.cpay(+el.dataset.cpay));
  on('[data-int]',el=>actions.int(+el.dataset.int));
  on('[data-cint]',el=>actions.cint(+el.dataset.cint));
  on('[data-bpay]',el=>actions.bpay(+el.dataset.bpay));
  on('[data-cbpay]',el=>actions.cbpay(+el.dataset.cbpay));
  on('[data-expand]',el=>{const id=+el.dataset.expand;expandedLoans.has(id)?expandedLoans.delete(id):expandedLoans.add(id);rnd();});
  on('[data-delloan]',el=>{const bk=JSON.parse(JSON.stringify(D)),id=+el.dataset.delloan;D.expense=D.expense.filter(e=>e.targetId!==id);D.history=D.history.filter(h=>h.targetId!==id);D.loans=D.loans.filter(x=>x.id!==id);sv();rnd();setUndo(bk,'ëŒ€ì¶œ ì‚­ì œë¨');});
  on('[data-q]',el=>{const t=el.dataset.q,id=+el.dataset.qid;t==='sav'?actions.dep(id):t==='int'?actions.int(id):actions.pay(id);});
  on('[data-delm]',el=>{const bk=JSON.parse(JSON.stringify(D));delete D.monthlyRecords[el.dataset.delm];sv();rnd();setUndo(bk,'ê¸°ë¡ ì‚­ì œë¨');});
  on('[data-tog]',el=>{const t=D.todos.find(x=>x.id===+el.dataset.tog);if(t){t.done=!t.done;sv();rnd();if(t.done)toast('ì™„ë£Œ!','âœ…');}});
  on('[data-dtodo]',el=>{const bk=JSON.parse(JSON.stringify(D));D.todos=D.todos.filter(x=>x.id!==+el.dataset.dtodo);sv();rnd();setUndo(bk,'í• ì¼ ì‚­ì œë¨');});
  
  $('assetSort')?.addEventListener('change',e=>{state.assetSort=e.target.value;rnd();});
  $('assetFilter')?.addEventListener('change',e=>{state.assetFilter=e.target.value;rnd();});
  $('goalSort')?.addEventListener('change',e=>{state.goalSort=e.target.value;rnd();});
  $('loanSort')?.addEventListener('change',e=>{state.loanSort=e.target.value;rnd();});
  $('prevM')?.addEventListener('click',()=>{state.flowMonth=adjMonth(state.flowMonth,-1);rnd();});
  $('nextM')?.addEventListener('click',()=>{state.flowMonth=adjMonth(state.flowMonth,1);rnd();});
  $('flowM')?.addEventListener('change',e=>{state.flowMonth=e.target.value;rnd();});
  $('applyFixed')?.addEventListener('click',()=>{let added=0;const tm=state.flowMonth;D.fixedIncome.forEach(f=>{if(!D.income.find(i=>i.fixedId===f.id&&i.month===tm)){D.income.push({id:genId(),name:f.name,amount:f.amount,month:tm,fixedId:f.id});added++;if(f.linkedAssetId){const a=D.assets.find(x=>x.id===f.linkedAssetId);if(a)a.amount+=f.amount;}}});D.fixedExpense.forEach(f=>{if(!D.expense.find(e=>e.fixedId===f.id&&e.month===tm)){D.expense.push({id:genId(),name:f.name,amount:f.amount,month:tm,fixedId:f.id,autoFixed:true});added++;if(f.linkedAssetId){const a=D.assets.find(x=>x.id===f.linkedAssetId);if(a)a.amount=Math.max(0,a.amount-f.amount);}}});sv();rnd();toast(added?`${added}ê±´ ë°˜ì˜`:'ì´ë¯¸ ë°˜ì˜ë¨','ğŸ“Œ');});
  
  const saveM=()=>{const k=gTM(),tA=D.assets.reduce((s,a)=>s+(a.amount||0),0),debt=D.loans.reduce((s,l)=>s+Math.max(0,(l.total||0)-(l.paid||0)),0);D.monthlyRecords[k]={date:localDate(),totalAsset:tA,netAsset:tA-debt,totalDebt:debt};sv();rnd();toast(k+' ì €ì¥!','ğŸ“¸');};
  $('btnSaveM')?.addEventListener('click',saveM);
  $('btnSaveM2')?.addEventListener('click',saveM);
  $('btnAddTodo')?.addEventListener('click',addTodo);
  $('todoInput')?.addEventListener('keypress',e=>{if(e.key==='Enter')addTodo();});
  $('btnClearDone')?.addEventListener('click',()=>{const bk=JSON.parse(JSON.stringify(D)),cnt=D.todos.filter(t=>t.done).length;D.todos=D.todos.filter(t=>!t.done);sv();rnd();setUndo(bk,`${cnt}ê°œ ì •ë¦¬ë¨`);});
  $('thD')?.addEventListener('click',()=>{document.body.classList.remove('light');localStorage.setItem('theme','dark');rnd();});
  $('thL')?.addEventListener('click',()=>{document.body.classList.add('light');localStorage.setItem('theme','light');rnd();});
  $('btnLogout')?.addEventListener('click',async()=>{if(confirm('ë¡œê·¸ì•„ì›ƒ?')){await auth.signOut();}});
  $('btnExp')?.addEventListener('click',()=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(D,null,2)],{type:'application/json'}));a.download='wealth-'+localDate()+'.json';a.click();toast('ë‚´ë³´ë‚´ê¸° ì™„ë£Œ','ğŸ“¤');});
  $('fImp')?.addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const p=JSON.parse(ev.target.result);D=JSON.parse(JSON.stringify(DEF));['assets','income','expense','fixedIncome','fixedExpense','goals','loans','todos','history'].forEach(k=>{if(Array.isArray(p[k]))D[k]=p[k];});if(p.monthlyRecords)D.monthlyRecords=p.monthlyRecords;sv();rnd();toast('ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!','ğŸ“¥');}catch{toast('íŒŒì¼ ì˜¤ë¥˜','âš ï¸');}};r.readAsText(f);e.target.value='';});
  $('btnRst')?.addEventListener('click',()=>{if(confirm('ëª¨ë“  ë°ì´í„° ì‚­ì œ?')){const bk=JSON.parse(JSON.stringify(D));D=JSON.parse(JSON.stringify(DEF));sv();rnd();setUndo(bk,'ì´ˆê¸°í™”ë¨');}});
}

function addTodo(){const inp=$('todoInput');if(!inp?.value.trim())return toast('ë‚´ìš© ì…ë ¥!','âš ï¸');D.todos.unshift({id:genId(),text:inp.value.trim(),done:false,date:localDate()});inp.value='';sv();rnd();toast('í• ì¼ ì¶”ê°€ë¨','âœ…');}

// ==================== ëª¨ë‹¬ ====================
function openM(type,id){
  const arr={fixedIncome:D.fixedIncome,fixedExpense:D.fixedExpense,income:D.income,expense:D.expense}[type]||D[type+'s'];
  const item=id?arr?.find(x=>x.id===id):null;
  const toUk=a=>Math.floor((a||0)/1e8),toMan=a=>Math.floor(((a||0)%1e8)/1e4);
  let o='<div class="md-h"></div>';
  
  if(type==='asset'){
    o+=`<h3>${item?'ìì‚° ìˆ˜ì •':'ìì‚° ì¶”ê°€'}</h3><div class="fg"><label>ì´ë¦„</label><input id="mN" value="${item?.name||''}"></div><div class="fg"><label>ì¹´í…Œê³ ë¦¬</label><select id="mCat">${['ì˜ˆê¸ˆ','ì €ì¶•','íˆ¬ì','ë¶€ë™ì‚°','í˜„ê¸ˆ','ê¸°íƒ€'].map(c=>`<option ${item?.category===c?'selected':''}>${c}</option>`).join('')}</select></div><div class="fg"><label>ê¸ˆì•¡</label><div class="amt-i"><input id="mAmtUk" type="number" min="0" value="${toUk(item?.amount)||''}"><span>ì–µ</span><input id="mAmtMan" type="number" min="0" value="${toMan(item?.amount)||''}"><span>ë§Œì›</span></div></div><div class="fg"><label>ë§¤ì›” ë³€ë™</label><div class="fr"><select id="mChgT"><option value="0" ${!item?.monthlyChange?'selected':''}>ì—†ìŒ</option><option value="+" ${item?.monthlyChange>0?'selected':''}>ì¦ê°€(+)</option></select><input id="mChgM" type="number" min="0" placeholder="ë§Œì›" value="${item?.monthlyChange?toMan(item.monthlyChange):''}"></div></div><div class="fg"><label>ë§Œê¸°ì¼</label><input id="mMat" type="month" value="${item?.maturityDate||''}"></div><div class="fg"><label>ëª©í‘œ ì—°ë™</label><select id="mGL"><option value="">ì—†ìŒ</option>${D.goals.map(g=>`<option value="${g.id}" ${item?.goalId===g.id?'selected':''}>${g.name}</option>`).join('')}</select></div>`;
  }else if(type==='income'||type==='expense'){
    o+=`<h3>${type==='income'?'ìˆ˜ì…':'ì§€ì¶œ'} ${item?'ìˆ˜ì •':'ì¶”ê°€'}</h3><div class="fg"><label>ì´ë¦„</label><input id="mN" value="${item?.name||''}"></div><div class="fg"><label>ê¸ˆì•¡</label><div class="amt-i"><input id="mAmtUk" type="number" min="0" value="${toUk(item?.amount)||''}"><span>ì–µ</span><input id="mAmtMan" type="number" min="0" value="${toMan(item?.amount)||''}"><span>ë§Œì›</span></div></div><div class="fg"><label>ì›”</label><input id="mMonth" type="month" value="${item?.month||state.flowMonth}"></div>`;
  }else if(type==='fixedIncome'||type==='fixedExpense'){
    const cats=type==='fixedIncome'?['ê¸‰ì—¬','ì‚¬ì—…','ì„ëŒ€','ì´ì','ê¸°íƒ€']:['ì£¼ê±°','í†µì‹ ','ë³´í—˜','êµ¬ë…','êµí†µ','ê¸°íƒ€'];
    o+=`<h3>ê³ ì • ${type==='fixedIncome'?'ìˆ˜ì…':'ì§€ì¶œ'} ${item?'ìˆ˜ì •':'ì¶”ê°€'}</h3><div class="fg"><label>ì´ë¦„</label><input id="mN" value="${item?.name||''}"></div><div class="fg"><label>ì¹´í…Œê³ ë¦¬</label><select id="mCat">${cats.map(c=>`<option ${item?.category===c?'selected':''}>${c}</option>`).join('')}</select></div><div class="fg"><label>ê¸ˆì•¡</label><div class="amt-i"><input id="mAmtUk" type="number" min="0" value="${toUk(item?.amount)||''}"><span>ì–µ</span><input id="mAmtMan" type="number" min="0" value="${toMan(item?.amount)||''}"><span>ë§Œì›</span></div></div><div class="fg"><label>${type==='fixedIncome'?'ì…ê¸ˆì¼':'ê²°ì œì¼'}</label><input id="mDue" type="number" min="1" max="31" value="${item?.dueDate||25}"></div><div class="fg"><label>ì—°ê²° ìì‚°</label><select id="mLinked"><option value="">ì—†ìŒ</option>${D.assets.map(a=>`<option value="${a.id}" ${item?.linkedAssetId===a.id?'selected':''}>${a.name}</option>`).join('')}</select></div>`;
  }else if(type==='goal'){
    const linked=item?getLinked(item.id):[],linkedAmt=linked.reduce((s,a)=>s+(a.amount||0),0),manualAmt=Math.max(0,(item?.current||0)-linkedAmt);
    o+=`<h3>${item?'ëª©í‘œ ìˆ˜ì •':'ëª©í‘œ ì¶”ê°€'}</h3><div class="fg"><label>ëª©í‘œëª…</label><input id="mN" value="${item?.name||''}"></div><div class="fg"><label>ëª©í‘œê¸ˆì•¡</label><div class="amt-i"><input id="mTgtUk" type="number" min="0" value="${toUk(item?.target)||''}"><span>ì–µ</span><input id="mTgtMan" type="number" min="0" value="${toMan(item?.target)||''}"><span>ë§Œì›</span></div></div>${linked.length?`<div class="fg"><label>ì—°ë™ ìì‚°</label><div style="padding:10px;background:var(--bg);border-radius:8px;color:var(--pri);font-weight:600">${fmtS(linkedAmt)}</div><div class="link-info">ğŸ”— ${linked.map(a=>a.name).join(', ')}</div></div>`:''}<div class="fg"><label>${linked.length?'ì§ì ‘ ì¶”ê°€':'í˜„ì¬ê¸ˆì•¡'}</label><div class="amt-i"><input id="mCurUk" type="number" min="0" value="${toUk(manualAmt)||''}"><span>ì–µ</span><input id="mCurMan" type="number" min="0" value="${toMan(manualAmt)||''}"><span>ë§Œì›</span></div></div><div class="fg"><label>ëª©í‘œì¼</label><input id="mDL" type="month" value="${item?.deadline||''}"></div>`;
  }else if(type==='loan'){
    o+=`<h3>${item?'ëŒ€ì¶œ ìˆ˜ì •':'ëŒ€ì¶œ ì¶”ê°€'}</h3><div class="fg"><label>ëŒ€ì¶œëª…</label><input id="mN" value="${item?.name||''}"></div><div class="fg"><label>ëŒ€ì¶œê¸ˆì•¡</label><div class="amt-i"><input id="mTotUk" type="number" min="0" value="${toUk(item?.total)||''}" oninput="updCalc()"><span>ì–µ</span><input id="mTotMan" type="number" min="0" value="${toMan(item?.total)||''}" oninput="updCalc()"><span>ë§Œì›</span></div></div><div class="fg"><label>ì—°ì´ìœ¨ (%)</label><input id="mRate" type="number" step="0.1" min="0" value="${item?.rate||''}" oninput="updCalc()"></div><div class="fg"><label>ìƒí™˜ë°©ì‹</label><select id="mLT" onchange="updCalc()"><option value="equal" ${item?.loanType==='equal'?'selected':''}>ì›ë¦¬ê¸ˆê· ë“±</option><option value="equal_principal" ${item?.loanType==='equal_principal'?'selected':''}>ì›ê¸ˆê· ë“±</option><option value="bullet" ${item?.loanType==='bullet'?'selected':''}>ë§Œê¸°ì¼ì‹œ</option></select></div><div class="fr"><div class="fg"><label>ì‹œì‘ì›”</label><input id="mStart" type="month" value="${item?.startDate||''}" oninput="updCalc()"></div><div class="fg"><label>ë§Œê¸°ì›”</label><input id="mEnd" type="month" value="${item?.endDate||''}" oninput="updCalc()"></div></div><div class="fg"><label>ìƒí™˜í•œ ì›ê¸ˆ</label><div class="amt-i"><input id="mPaidUk" type="number" min="0" value="${toUk(item?.paid)||''}" oninput="updCalc()"><span>ì–µ</span><input id="mPaidMan" type="number" min="0" value="${toMan(item?.paid)||''}" oninput="updCalc()"><span>ë§Œì›</span></div></div><div class="calc-box" id="calcBox"><div class="no-item">ì •ë³´ ì…ë ¥ì‹œ ìë™ê³„ì‚°</div></div>`;
  }
  o+=`<div class="md-btns">${item?`<button class="btn btn-d" id="mDel">ì‚­ì œ</button>`:''}<button class="btn btn-o" id="mCan">ì·¨ì†Œ</button><button class="btn btn-p" id="mSav">ì €ì¥</button></div>`;
  $('md').innerHTML=o;$('mo').classList.add('act');
  $('mCan').onclick=()=>$('mo').classList.remove('act');
  $('mSav').onclick=()=>saveItem(type,id);
  $('mDel')?.addEventListener('click',()=>{if(confirm('ì‚­ì œ?')){const bk=JSON.parse(JSON.stringify(D));delItem(type,id);$('mo').classList.remove('act');setUndo(bk,'ì‚­ì œë¨');}});
  $('mo').onclick=e=>{if(e.target===e.currentTarget)$('mo').classList.remove('act');};
  if(type==='loan')setTimeout(updCalc,100);
}

window.updCalc=function(){
  const gAmt=p=>(+$(`${p}Uk`)?.value||0)*1e8+(+$(`${p}Man`)?.value||0)*1e4;
  const total=gAmt('mTot'),rate=+$('mRate')?.value||0,type=$('mLT')?.value||'equal',start=$('mStart')?.value,end=$('mEnd')?.value;
  const months=diffMonth(start,end),remM=remainMonth(end),paid=gAmt('mPaid'),rem=Math.max(0,total-paid);
  const lc=calcLoan(total,rate,months,type,rem,remM),totalInt=calcTotalInt(total,rate,months,type);
  const box=$('calcBox');if(box)box.innerHTML=`<div class="row"><span>ì´/ë‚¨ì€ ê¸°ê°„</span><span>${months}/${remM}ê°œì›”</span></div><div class="row"><span>ë‚¨ì€ ì›ê¸ˆ</span><span>${fmtS(rem)}</span></div><div class="row"><span>${type==='bullet'?'ì›” ì´ì':'ì›” ë‚©ì…'}</span><span>${fmtS(type==='bullet'?lc.mi:lc.mp+lc.mi)}</span></div><div class="row"><span>ì´ ì´ì</span><span>${fmtS(totalInt)}</span></div>`;
};

function saveItem(type,id){
  const gAmt=p=>(+$(`${p}Uk`)?.value||0)*1e8+(+$(`${p}Man`)?.value||0)*1e4;
  const name=$('mN')?.value?.trim();if(!name)return toast('ì´ë¦„ ì…ë ¥!','âš ï¸');
  let arr={fixedIncome:D.fixedIncome,fixedExpense:D.fixedExpense,income:D.income,expense:D.expense}[type]||D[type+'s'];
  let item=id?arr.find(x=>x.id===id):null;
  const isNew=!item;if(isNew){item={id:genId()};arr.push(item);}
  
  if(type==='asset'){
    const oldGid=isNew?null:item.goalId,oldAmt=isNew?0:item.amount||0;
    const newGid=$('mGL').value?+$('mGL').value:null,newAmt=gAmt('mAmt');
    item.name=name;item.category=$('mCat').value;item.amount=newAmt;
    item.monthlyChange=$('mChgT').value==='+'?(+$('mChgM').value||0)*1e4:0;
    item.maturityDate=$('mMat')?.value||null;item.goalId=newGid;
    if(newGid===oldGid&&newGid){if(newAmt!==oldAmt)updateGoal(newGid,newAmt-oldAmt);}
    else{if(oldGid)updateGoal(oldGid,-oldAmt);if(newGid)updateGoal(newGid,newAmt);}
  }else if(type==='income'||type==='expense'){
    item.name=name;item.amount=gAmt('mAmt');item.month=$('mMonth')?.value||state.flowMonth;
  }else if(type==='fixedIncome'||type==='fixedExpense'){
    item.name=name;item.category=$('mCat').value;item.amount=gAmt('mAmt');item.dueDate=+$('mDue').value||1;
    item.linkedAssetId=$('mLinked')?.value?+$('mLinked').value:null;
  }else if(type==='goal'){
    const linked=item.id?getLinked(item.id):[],linkedAmt=linked.reduce((s,a)=>s+(a.amount||0),0);
    item.name=name;item.target=gAmt('mTgt');item.current=linkedAmt+gAmt('mCur');item.deadline=$('mDL')?.value||null;
  }else if(type==='loan'){
    const start=$('mStart').value,end=$('mEnd').value;
    if(start&&end&&start>end)return toast('ì‹œì‘ì›”ì´ ë§Œê¸°ì›”ë³´ë‹¤ ëŠ¦ì–´ìš”!','âš ï¸');
    item.name=name;item.total=gAmt('mTot');item.paid=gAmt('mPaid');item.rate=+$('mRate').value||0;
    item.loanType=$('mLT').value;item.startDate=start;item.endDate=end;
  }
  $('mo').classList.remove('act');sv();rnd();toast('ì €ì¥ë¨','ğŸ’¾');
}

function delItem(type,id){
  if(type==='asset'){const a=D.assets.find(x=>x.id===id);if(a?.goalId)updateGoal(a.goalId,-a.amount);D.expense=D.expense.filter(e=>e.targetId!==id);D.history=D.history.filter(h=>h.targetId!==id);D.assets=D.assets.filter(x=>x.id!==id);}
  else if(type==='goal'){D.assets.forEach(a=>{if(a.goalId===id)a.goalId=null;});D.goals=D.goals.filter(x=>x.id!==id);}
  else if(type==='loan'){D.expense=D.expense.filter(e=>e.targetId!==id);D.history=D.history.filter(h=>h.targetId!==id);D.loans=D.loans.filter(x=>x.id!==id);}
  else if(type==='fixedIncome'){D.income=D.income.filter(i=>i.fixedId!==id);D.fixedIncome=D.fixedIncome.filter(x=>x.id!==id);}
  else if(type==='fixedExpense'){D.expense=D.expense.filter(e=>e.fixedId!==id);D.fixedExpense=D.fixedExpense.filter(x=>x.id!==id);}
  else{const k=type==='income'||type==='expense'?type:type+'s';D[k]=D[k].filter(x=>x.id!==id);}
  sv();rnd();
}

// ==================== ì´ˆê¸°í™” ====================
const th=localStorage.getItem('theme');
if(th==='light'||(th!=='dark'&&matchMedia('(prefers-color-scheme:light)').matches))document.body.classList.add('light');
showLoading();
</script>

</body>
</html>